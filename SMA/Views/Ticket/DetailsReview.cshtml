@model SMA.Entities.TTicket

@{
    ViewData["Title"] = "Detalles ticket";
}



<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Ticket #<b>@Model.NumTicket</b></h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index","Principal")">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index","Ticket")">Tickets</a></li>
                    <li class="breadcrumb-item active">Detalles</li>
                </ol>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>




<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                @{
                    var propietario = Model.IdUsuarioNavigation.Nombre + " " + Model.IdUsuarioNavigation.Apellidos;
                }
                <div class="row">
                    <h6 class="control-label ml-3 mr-2">Por:</h6>
                    <div class="badge badge-pill badge-secondary"><h6> @propietario</h6></div>
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label asp-for="Titulo" class="control-label"></label>
                    <input asp-for="Titulo" class="form-control" readonly />
                </div>
                <div class="form-group">
                    <label asp-for="Descripcion" class="control-label"></label>
                    <textarea asp-for="Descripcion" class="form-control" style="height: 150px" readonly></textarea>
                </div>
                <div class="row">
                    <div class="form-group col-md-6">
                        <label asp-for="IdPrioridad" class="control-label"></label>
                        <input asp-for="IdPrioridadNavigation.TipoPrioridad" class="form-control" readonly />
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="Fecha" class="control-label"></label>
                        <input value="@ViewBag.Fecha" class="form-control text-sm" readonly />
                    </div>
                </div>
            </div>
            @if (Model.TArchivos != null && Model.TArchivos.Count > 0)
            {


                <div class="card">
                    <div class="card-header">
                        <label><strong>Archivos</strong> (@Model.TArchivos.Count)</label>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: scroll">
                        <div class="row">
                            <div class="col-sm-3 font-weight-bold">

                            </div>

                            <ul class="col-sm-9 list-unstyled">
                                @foreach (var item in Model.TArchivos)
                                {

                                    <li>
                                        <p>@item.Nombre</p>

                                        <form asp-action="DownloadFile" enctype="multipart/form-data" method="post">
                                            <input type="hidden" asp-for="@item.IdArchivo" name="idArchivo" />
                                            <button type="submit" class="btn btn-sm btn-info"><i class="fa-solid fa-download"></i> Descargar archivos</button>
                                        </form>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>



            }
            else
            {
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-2 font-weight-bold">
                                <label>Archivos</label>
                            </div>
                            <div class="col-sm-10">
                                <p>Este registro no posee archivos.</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>


    @if (!Model.Revisado)
    {
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="text-center font-weight-bold">Revisión del ticket</h4>
                </div>
                <form id="form" asp-action="SaveRevision" method="post">
                    <input type="hidden" name="IdTicket" value="@Model.NumTicket" />
                    <div class="card-body">
                        <div class="form-group">
                            <label class="control-label">Observaciones</label>
                            <textarea name="Observacion" id="Observacion" class="form-control"></textarea>
                            <span id="Observacion-error" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Prioridad</label>
                            <select name="IdPrioridad" class="form-control" asp-items="ViewBag.IdPrioridad"></select>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Estado</label>
                            <select name="IdEstado" class="form-control" asp-items="ViewBag.IdEstado"></select>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-right">
                                <input type="button" onclick="confirmation()" value="Guardar" class="btn btn-success" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="text-center font-weight-bold"><i class="text-success fa-solid fa-circle-check"></i>  Este ticket ya fue revisado</h4>
                </div>
                <input type="hidden" name="IdTicket" value="@Model.NumTicket" />
                <div class="card-body">

                    <div class="form-group">
                        <label class="control-label">Prioridad</label>
                        <input asp-for="@Model.IdRevisionNavigation.IdPrioridadNavigation.TipoPrioridad" class="form-control" readonly />
                    </div>
                    <div class="form-group">
                        <label class="control-label">Estado</label>
                        <input asp-for="@Model.IdRevisionNavigation.IdEstadoNavigation.Tipo" class="form-control" readonly />
                    </div>
                    <div class="form-group">
                        <label class="control-label">Observaciones</label>
                        <textarea style="height: 150px" asp-for="@Model.IdRevisionNavigation.Observacion" class="form-control" readonly></textarea>
                        
                    </div>
                    <div class="row">
                        <div class="col-md-12 text-right">
                            <input type="submit" value="Guardar" class="btn btn-success" disabled />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }





</div>


<div>
    <a asp-action="Index"><i class="fa-solid fa-circle-arrow-left"></i>   Volver atrás</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>

        function confirmation() {
            swal({
                title: "Confirmar",
                text: "Una vez revisado el ticket, no se podrá editar. Revise bien la información que será enviada.",
                icon: "info",
                buttons: true,
                dangerMode: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',

                buttons: ["Cancelar", "Confirmar"],

            })
                .then((result) => {
                    if (result) {

                        var p = document.getElementById('Observacion');
                        debugger;
                        if (document.getElementById('Observacion').value == '') {
                            document.getElementById('Observacion-error').innerHTML = 'Observación es un campo requerido.';
                            return;
                        }

                        document.getElementById('form').submit();
                    }
                });
        }

    </script>
}

